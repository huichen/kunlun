代码索引原理
======

#### 三元组索引

昆仑使用基于三元组（trigram）的内存索引，比如 "CPU cache" 这个词，会分解成下面的索引键（预先转化为小写）

```
cpu
pu_
u_c
_ca
cac
ach
che
```

然后我们使用 (trigram -> docID) 组成倒排索引，当搜索任何单词时，首先将关键词按照同样方法分解为多个三元组，比如搜索 "cache" 这个词，通过 "cac" 和 "che" 这两个三元组，以及它们之间的距离(2)，找到所有的候选文档以及文档中这两个三元组出现的位置，再通过 cache 做位置上的局部匹配，最终确定召回哪些文档。

在索引 trigram 的同时，我们也索引了二元组和一元组，方便当用户检索的关键词小于 3 个字符的时候能快速检索。

#### Unicode 支持

为了支持 Unicode 编码，我们参考了 zoekt 的方案，实际的索引键为 UTF-8 三元组，因为一个 UTF-8 字符最多为 21 个字节，所以可以用 63 个字节也就是一个 64 位的 uint64 数字来完全描述一个索引键：

```
key = uc1 << 42 + uc2 << 21 + uc3
```

#### 索引分片

为了加快索引和检索的速度，昆仑会创建多个索引分片，按照 docID 不同发送到不同的分片中，启动引擎时可以通过 [NumIndexerShards](https://github.com/huichen/kunlun/blob/master/pkg/types/indexer_options.go) 参数设置分片数，默认为 CPU 核数。

同时我们支持通过 MaxDocsPerShard 参数控制一个分片最多容纳多少 docID（默认不设限制），方便根据文档数量做弹性扩容。

#### 纯内存索引

和其他一些代码搜索引擎不同，我们没有做索引持久化，而是把所有索引直接保存在内存，基于如下考虑

1.  内存索引是最快的，不仅创建索引速度加快，也极大加快了搜索结果标注（附加内容等信息）的速度，这对一款实用的搜索应用极为重要
2.  和 elastic search 等全文搜索引擎不同，待检索文档（代码）的总字节数通常不会太高，以一个千人规模互联网公司为例，代码通常在 1GB 字节以下（纯文本，不包括多媒体和历史版本等），如果索引构建速度足够快（比如一分钟以内）且内存空间足够，那并不需要索引文件
2.  没有索引文件避免数据落盘，降低了代码泄露的风险